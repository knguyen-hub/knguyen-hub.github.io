<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
    <style>
        video, canvas {
            border: 3px solid black;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h2>Hello OpenCV.js</h2>
    <p id="status">OpenCV.js is loading...</p>

    <video id="video" autoplay></video>
    <canvas id="canvasFrame"></canvas>
    <canvas id="canvasOutput"></canvas>
    
    <script type="text/javascript">
        
        var Module = {
            // https://emscripten.org/docs/api_reference/module.html#Module.onRuntimeInitialized
            onRuntimeInitialized() {
                document.getElementById('status').innerHTML = 'OpenCV.js is ready.';

                let video = document.getElementById("video");

                let width = 0;
                let height = 0;

                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(stream => {
                        video.srcObject = stream;
                        video.play();
                        // Set canvas dimensions to match video dimensions
                        video.addEventListener('loadedmetadata', () => {
                            width = video.videoWidth;
                            
                            height = video.videoHeight;
                            
                        });
                    })
                    
                    .catch(err => {
                        console.error("Error accessing webcam: ", err);
                    });

                let canvasFrame = document.getElementById("canvasFrame");
                let context = canvasFrame.getContext("2d");
                let src = new cv.Mat(height, width, cv.CV_8UC4);
                let dst = new cv.Mat(height, width, cv.CV_8UC1);
                let cap = new cv.VideoCapture(video);
                const FPS = 30;
                function processVideo() {
                    try {
                        /*if (!streaming) {
                            src.delete();
                            dst.delete();
                            return;
                        }*/
                        let begin = Date.now();
                        cap.read(src);

                        cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                        cv.imshow("canvasOutput", dst);
                        // schedule next one.
                        let delay = 1000/FPS - (Date.now() - begin);
                        setTimeout(processVideo, delay);
                    } catch (err) {
                        console.error(err);
                    }
                    
                };
                setTimeout(processVideo, 0);
            }
        };

        
    </script>
    <script async src="opencv.js" type="text/javascript"></script>
</body>

</html>